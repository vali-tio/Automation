<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Automation Lite ‚Äî Full Premium</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
  :root{--bg:#0f172a;--card:#0b1220;--muted:#9aa5b1;--accent:#16a34a}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#071025 0%, #071a14 100%);color:#e6eef3}
  .wrap{max-width:920px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:20px;margin:0}
  .lead{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
  button{background:var(--accent);border:none;color:#063018;padding:10px 12px;border-radius:10px;cursor:pointer}
  .ghost{background:transparent;color:#cfe9d6;border:1px solid rgba(255,255,255,0.04)}
  .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px;margin-top:12px}
  .row{display:flex;gap:8px;align-items:center}
  .rules{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
  .rule{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .small{font-size:12px;color:var(--muted)}
  label{display:block;font-size:13px;margin-top:6px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:999px;font-size:12px}
  footer{margin-top:14px;color:var(--muted);font-size:13px}
  .badge{background:rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;font-size:12px}
  .danger{background:#7c1d1d}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Automation Lite ‚Äî (Full Premium)</h1>
      <div class="lead">Uji coba otomatisasi di browser. Semua fitur premium disimulasikan & dapat langsung dipakai. (Simpan & buka di HP untuk uji nyata)</div>
    </div>
  </header>
<footer id="donateFooter">
  <span>Gratis untuk semua</span>
  <a href="https://saweria.co/valitio" target="_blank" rel="noopener noreferrer">
    üíù Dukung via Saweria
  </a>
</footer>

<style>
  #donateFooter {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    background: var(--card);
    border-top: 1px solid var(--border);
    color: var(--text);
    font-size: 0.9rem;
    text-align: center;
    padding: 10px;
    display: flex;
    justify-content: center;
    gap: 10px;
    z-index: 999;
  }
  #donateFooter a {
    color: #f97316;
    font-weight: 600;
    text-decoration: none;
  }
  #donateFooter a:hover {
    text-decoration: underline;
  }
</style>

  <div class="controls">
    <button id="btnNew">‚ûï Buat Rule Baru</button>
    <button id="btnExport" class="ghost">‚¨áÔ∏è Export Rules</button>
    <button id="btnImport" class="ghost">‚¨ÜÔ∏è Import Rules</button>
    <button id="btnDemo" class="ghost">‚ú® Muat Preset Premium</button>
    <div style="margin-left:auto" class="row"><div class="badge">Unlimited Rules ‚Ä¢ Gratis ‚Ä¢ Tanpa Iklan</div></div>
  </div>

  <div class="card">
    <div class="flex-between"><strong>Rules Aktif</strong><span class="small">Status: <span id="statusOnline">--</span></span></div>
    <div class="hint">Rules berjalan di tab ini ‚Äî untuk uji lebih lanjut simpan halaman ini lalu buka kembali. (Beberapa fitur butuh izin browser)</div>

    <div id="rulesContainer" class="rules"></div>
  </div>

  <div id="editor" class="card" style="display:none">
    <h3 id="editorTitle">Buat Rule Baru</h3>
    <div class="two">
      <div>
        <label>Nama Rule</label>
        <input id="ruleName" placeholder="Contoh: Silent malam" />
      </div>
      <div>
        <label>Aktifkan</label>
        <select id="ruleEnabled"><option value="1">Ya</option><option value="0">Tidak</option></select>
      </div>
    </div>

    <label>Trigger (Pilih 1 atau lebih)</label>
    <div class="two">
      <div>
        <label>Waktu (hh:mm)</label>
        <input id="triggerTime" type="time" />
      </div>
      <div>
        <label>Baterai &lt;= (%)</label>
        <input id="triggerBattery" type="number" min="1" max="100" placeholder="kosongkan jika tidak" />
      </div>
    </div>
    <div class="two">
      <div>
        <label>Terhubung ke WiFi (nama SSID) ‚Äî kosong untuk semua</label>
        <input id="triggerWifi" placeholder="Contoh: Indihome-123" />
      </div>
      <div>
        <label>Geofence (koordinat lat,lng dan radius m)</label>
        <input id="triggerGeo" placeholder="-6.200000,106.816666,200" />
      </div>
    </div>

    <label>Aksi (Pilih satu atau lebih)</label>
    <div class="two">
      <div>
        <label>Notifikasi (teks)</label>
        <input id="actionNotify" placeholder="Contoh: Waktu tidur..." />
      </div>
      <div>
        <label>Ubah Tema</label>
        <select id="actionTheme"><option value="">(tidak)</option><option value="dark">Dark</option><option value="light">Light</option></select>
      </div>
    </div>
    <div class="two">
      <div>
        <label>Putar Suara (URL mp3) ‚Äî kosong untuk beep</label>
        <input id="actionSound" placeholder="https://example.com/beep.mp3" />
      </div>
      <div>
        <label>Buka URL (aksi)</label>
        <input id="actionOpen" placeholder="https://" />
      </div>
    </div>

    <label>Advanced (opsional)</label>
    <textarea id="advancedScript" rows="4" placeholder="JavaScript kecil (contoh: console.log('halo');)"></textarea>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btnSave">Simpan Rule</button>
      <button id="btnCancel" class="ghost">Batal</button>
      <button id="btnTest" class="ghost">Tes Sekarang</button>
    </div>
  </div>

  <footer>
    Fitur Web Demo: multiple triggers, geofence (permisi lokasi), battery API, notifications, play sound, vibrate, export/import JSON, advanced script. <br>
    Batasan: browser tidak boleh mematikan WiFi/volume/menjalankan app lain ‚Äî aksi tersebut disimulasikan (notifikasi/URL/vibrate). Untuk kontrol hardware diperlukan versi native.
  </footer>
</div>

<script>
// Storage key
const KEY = 'automation_lite_rules_v1';
let rules = JSON.parse(localStorage.getItem(KEY) || '[]');
let editingId = null;
const rulesContainer = document.getElementById('rulesContainer');
const editor = document.getElementById('editor');
const statusOnline = document.getElementById('statusOnline');

// Elements
const btnNew = document.getElementById('btnNew');
const btnExport = document.getElementById('btnExport');
const btnImport = document.getElementById('btnImport');
const btnDemo = document.getElementById('btnDemo');

// Editor elements
const ruleName = document.getElementById('ruleName');
const ruleEnabled = document.getElementById('ruleEnabled');
const triggerTime = document.getElementById('triggerTime');
const triggerBattery = document.getElementById('triggerBattery');
const triggerWifi = document.getElementById('triggerWifi');
const triggerGeo = document.getElementById('triggerGeo');
const actionNotify = document.getElementById('actionNotify');
const actionTheme = document.getElementById('actionTheme');
const actionSound = document.getElementById('actionSound');
const actionOpen = document.getElementById('actionOpen');
const advancedScript = document.getElementById('advancedScript');
const btnSave = document.getElementById('btnSave');
const btnCancel = document.getElementById('btnCancel');
const btnTest = document.getElementById('btnTest');

btnNew.onclick = ()=>{openEditor();}
btnCancel.onclick = closeEditor;
btnSave.onclick = saveRule;
btnExport.onclick = exportRules;
btnImport.onclick = importRules;
btnTest.onclick = ()=>{ if(editingId===null) {alert('Buat rule dulu atau edit rule yang ada');} else testRule(editingId)};
btnDemo.onclick = loadDemo;

function uid(){return 'r'+Math.random().toString(36).slice(2,9)}

function openEditor(rule=null){
  editor.style.display='block';
  if(rule){
    editingId = rule.id;
    document.getElementById('editorTitle').innerText='Edit Rule';
    ruleName.value = rule.name;
    ruleEnabled.value = rule.enabled? '1' : '0';
    triggerTime.value = rule.triggerTime || '';
    triggerBattery.value = rule.triggerBattery || '';
    triggerWifi.value = rule.triggerWifi || '';
    triggerGeo.value = rule.triggerGeo || '';
    actionNotify.value = rule.actionNotify || '';
    actionTheme.value = rule.actionTheme || '';
    actionSound.value = rule.actionSound || '';
    actionOpen.value = rule.actionOpen || '';
    advancedScript.value = rule.advancedScript || '';
  } else {
    editingId = null;
    document.getElementById('editorTitle').innerText='Buat Rule Baru';
    ruleName.value=''; ruleEnabled.value='1'; triggerTime.value=''; triggerBattery.value=''; triggerWifi.value=''; triggerGeo.value=''; actionNotify.value=''; actionTheme.value=''; actionSound.value=''; actionOpen.value=''; advancedScript.value='';
  }
}

function closeEditor(){ editor.style.display='none'; editingId = null }

function saveRule(){
  const r = {
    id: editingId || uid(),
    name: ruleName.value || 'Rule tanpa nama',
    enabled: ruleEnabled.value === '1',
    triggerTime: triggerTime.value || null,
    triggerBattery: triggerBattery.value? Number(triggerBattery.value) : null,
    triggerWifi: triggerWifi.value || null,
    triggerGeo: triggerGeo.value || null,
    actionNotify: actionNotify.value || null,
    actionTheme: actionTheme.value || null,
    actionSound: actionSound.value || null,
    actionOpen: actionOpen.value || null,
    advancedScript: advancedScript.value || null,
    created: Date.now()
  };

  const idx = rules.findIndex(x=>x.id===r.id);
  if(idx>=0) rules[idx] = r; else rules.push(r);
  persist(); renderRules(); closeEditor();
}

function persist(){ localStorage.setItem(KEY, JSON.stringify(rules)); }

function renderRules(){
  rulesContainer.innerHTML = '';
  if(rules.length===0){ rulesContainer.innerHTML='<div class="small">Belum ada rule. Klik "Buat Rule Baru" untuk mulai.</div>'; return }
  rules.forEach(r=>{
    const el = document.createElement('div'); el.className='rule';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${escapeHtml(r.name)}</strong><div class='small'>ID: ${r.id}</div></div><div style='display:flex;gap:6px'><button class='ghost' data-id='${r.id}' data-act='edit'>Edit</button><button class='ghost' data-id='${r.id}' data-act='test'>Tes</button><button class='danger' data-id='${r.id}' data-act='del'>Hapus</button></div></div>
      <div class='small' style='margin-top:8px'>Triggers: ${listTriggers(r)} | Actions: ${listActions(r)}</div>`;
    rulesContainer.appendChild(el);
  })
}

function listTriggers(r){ const arr=[]; if(r.triggerTime) arr.push('Time:'+r.triggerTime); if(r.triggerBattery) arr.push('Battery<='+r.triggerBattery+'%'); if(r.triggerWifi) arr.push('WiFi:'+r.triggerWifi); if(r.triggerGeo) arr.push('Geo:'+r.triggerGeo); return arr.join(', ') }
function listActions(r){ const a=[]; if(r.actionNotify) a.push('Notify'); if(r.actionTheme) a.push('Theme'); if(r.actionSound) a.push('Sound'); if(r.actionOpen) a.push('OpenURL'); if(r.advancedScript) a.push('Script'); return a.join(', ') }

rulesContainer.addEventListener('click', e=>{
  const b = e.target.closest('button'); if(!b) return; const id = b.dataset.id; const act = b.dataset.act;
  const rule = rules.find(x=>x.id===id);
  if(act==='edit') openEditor(rule);
  if(act==='del') { if(confirm('Hapus rule ini?')){ rules = rules.filter(x=>x.id!==id); persist(); renderRules(); }}
  if(act==='test') testRule(id);
});

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]) }

// Export / Import
function exportRules(){ const data = JSON.stringify(rules, null, 2); const blob = new Blob([data], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'automation_rules.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),3000); }
function importRules(){ const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = ()=>{
  const f = inp.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ try{ const arr = JSON.parse(reader.result); if(Array.isArray(arr)){ rules = arr; persist(); renderRules(); alert('Import sukses'); } else alert('File tidak valid'); }catch(err){alert('Gagal parse: '+err.message)} }; reader.readAsText(f);
}; inp.click(); }

// Test rule now
async function testRule(id){ const r = rules.find(x=>x.id===id); if(!r) return alert('Rule tidak ditemukan'); await runActions(r, {reason:'manual_test'}); }

// Core runner
async function runActions(rule, ctx){ console.log('RUN rule', rule.id, ctx);
  if(rule.actionNotify){ await notify(`${rule.name}: ${rule.actionNotify}`, rule.actionNotify); }
  if(rule.actionTheme){ applyTheme(rule.actionTheme); }
  if(rule.actionSound){ playSound(rule.actionSound); } else if(rule.actionNotify) { beep(); }
  if(rule.actionOpen){ window.open(rule.actionOpen,'_blank'); }
  if(rule.advancedScript){ try{ const fn = new Function('ctx', rule.advancedScript); fn(ctx); }catch(e){console.error('Script error', e)} }
}

function beep(){ try{ navigator.vibrate && navigator.vibrate(200); new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=').play().catch(()=>{}); }catch(e){} }

function playSound(url){ try{ const a = new Audio(url); a.play().catch(()=>alert('Gagal mainkan suara (cek URL)')); }catch(e){console.error(e)} }

function applyTheme(t){ if(t==='dark'){ document.documentElement.style.setProperty('--bg','#071025'); } else if(t==='light'){ document.documentElement.style.setProperty('--bg','#f6f9fc'); } }

// Notification helper
async function notify(title, body){ if(!('Notification' in window)) { alert(body); return }
  if(Notification.permission==='granted'){
    new Notification(title, {body:body});
  } else if(Notification.permission!=='denied'){
    const p = await Notification.requestPermission(); if(p==='granted'){ new Notification(title, {body:body}); } else { alert(body); }
  } else alert(body);
}

// Runner loop: check triggers every 15s
setInterval(checkAllTriggers, 15000);

async function checkAllTriggers(){ statusOnline.innerText = navigator.onLine ? 'Online' : 'Offline';
  const now = new Date(); const hh = String(now.getHours()).padStart(2,'0'); const mm = String(now.getMinutes()).padStart(2,'0'); const cur = hh+':'+mm;
  const batt = await readBatteryLevel();
  for(const r of rules){ if(!r.enabled) continue;
    // time trigger
    if(r.triggerTime && r.triggerTime===cur){ await runActions(r, {trigger:'time', at:cur}); }
    // battery
    if(r.triggerBattery && batt!==null && batt<=r.triggerBattery){ await runActions(r, {trigger:'battery', level:batt}); }
    // wifi trigger (best effort: compare navigator.connection?.effectiveType and online state) ‚Äî can't read SSID in browser
    if(r.triggerWifi && navigator.onLine && r.triggerWifi.trim()!==''){ // simulate: if online -> trigger
      await runActions(r, {trigger:'wifi', info:'online_simulated'});
    }
    // geofence: use geolocation and calc distance
    if(r.triggerGeo){ const parts = r.triggerGeo.split(',').map(x=>x.trim()); if(parts.length>=3){ try{ const pos = await getPosition(5000); const lat=Number(parts[0]), lng=Number(parts[1]), rad=Number(parts[2]); const d = distanceMeters(lat,lng,pos.coords.latitude,pos.coords.longitude); if(d<=rad) await runActions(r, {trigger:'geo', distance:d}); }catch(e){} }
    }
  }
}

function distanceMeters(lat1,lon1,lat2,lon2){ function toRad(v){return v*Math.PI/180} const R=6371000; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2); const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c }

function getPosition(timeout=7000){ return new Promise((res,rej)=>{ if(!navigator.geolocation) return rej(new Error('No geolocation')); navigator.geolocation.getCurrentPosition(res, rej, {enableHighAccuracy:false,timeout:timeout}); }) }

// Battery API
async function readBatteryLevel(){ try{ if(navigator.getBattery){ const bat = await navigator.getBattery(); return Math.round(bat.level*100); } return null; }catch(e){return null} }

// Load initial
renderRules();

// Drag-drop demo import
window.addEventListener('online', ()=>statusOnline.innerText='Online');
window.addEventListener('offline', ()=>statusOnline.innerText='Offline');

// Demo presets
function loadDemo(){ rules = [
  {id:uid(), name:'Silent malam (preset)', enabled:true, triggerTime:'22:00', actionNotify:'Mode silent malam aktif', actionTheme:'dark', actionSound:null, actionOpen:null, advancedScript:"console.log('Silent mode simulated');"},
  {id:uid(), name:'Hemat baterai', enabled:true, triggerBattery:25, actionNotify:'Baterai <=25%', actionTheme:'', actionSound:null, actionOpen:null, advancedScript:"console.log('Battery saver')"},
  {id:uid(), name:'Sambung WiFi (simulasi)', enabled:true, triggerWifi:'*', actionNotify:'Terhubung WiFi (simulated)', actionOpen:null}
]; persist(); renderRules(); alert('Preset premium dimuat ‚Äî Anda dapat edit tiap rule.'); }

// On load ask notification permission
if('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied'){
  Notification.requestPermission().then(()=>{});
}

// Load sample from URL param? (for mobile quick test) - optional
(function(){ const p = new URLSearchParams(location.search); if(p.get('demo')) loadDemo(); })();
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("SW registration failed:", err));
    }
</script>
</body>
</html>
